<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>Детали заказа — x86 Trade</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="shortcut icon" href="images/favicon.svg" type="image/x-icon" />
</head>
<body>
<header class="header">
      <div class="container">
        <div class="header_inner">
          <a href="index.html" class="logo">
            <img src="images/logo.svg" alt="" />
            <div class="name_logo">x86 Trade</div>
          </a>
          <nav class="menu">
            <button class="menu_btn">
              <span> </span>
              <span> </span>
              <span> </span>
            </button>
            <ul class="menu_list">
              <li class="menu_item">
                <a href="index.html" class="menu_link">Главная</a>
              </li>
              <li class="menu_item">
                <a href="delivery.html" class="menu_link">Доставка</a>
              </li>
              <li class="menu_item">
                <a href="about.html" class="menu_link">О нас</a>
              </li>
              <li class="menu_item">
                <a href="vacancy.html" class="menu_link">Вакансии</a>
              </li>
              <li class="menu_item">
                <a href="contact.html" class="menu_link">Контакты</a>
              </li>
            </ul>
          </nav>
          <ul class="user-actions">
            <li class="user-actions_item">
              <a href="cart.html" class="user-actions_link cart-container">
                <img src="images/cart.svg" alt="Корзина" class="cart-icon" />
                <span class="tooltip">Корзина</span>
              </a>
            </li>

            <li class="user-actions_item">
              <div class="user-actions_link profile-container" style="position:relative;">
                <!-- Контент будет отрисован JS (иконка / dropdown или вызов модалки) -->
              </div>
            </li>

            <li class="user-actions_item user-actions_item-search">
              <a href="#" class="user-actions_link search-container">
                <img src="images/search.svg" alt="Поиск" class="search-icon" />
                <span class="tooltip">Поиск</span>
              </a>
            </li>
          </ul>
          <!-- Блок с текущим временем -->
          <div class="time-display" id="current-time"></div>
        </div>
      </div>
    </header>
  
  <main class="main">
    <section class="order_details_section">
      <div class="container">
        <h2>Детали заказа</h2>
        <div id="orderDetailsContainer">
          <div class="loader">Загрузка деталей заказа...</div>
        </div>
        <div class="order_actions">
          <a href="profile.html" class="btn secondary">Назад к заказам</a>
        </div>
      </div>
    </section>
  </main>
  
<footer class="footer_distributed">
      <div class="footer_left">
        <div class="logo_footer">
          <a href="index.html" class="logo">
            <img src="images/logo.svg" alt="" />
            <div class="name_logo">x86 Trade</div>
          </a>
        </div>
        <p class="footer_links">
          <a href="index.html" class="link_1">Главная</a>
          <a href="delivery.html">Доставка</a>
          <a href="vacancy.html">Вакансии</a>
          <a href="about.html">О нас</a>
          <a href="contact.html">Контакты</a>
        </p>
        <p class="footer_company_name">x86 Trade © 2025</p>
      </div>
      <div class="footer_center">
        <div>
          <img src="images/location.svg" alt="Адрес" class="footer_icon" />
          <p><span>ул. Попова 42</span> Белгород, Россия</p>
        </div>
        <div>
          <img src="images/phone.svg" alt="Телефон" class="footer_icon" />
          <p>+7 999 999 999</p>
        </div>
        <div>
          <img src="images/email.svg" alt="Почта" class="footer_icon" />
          <p><a href="mailto:x86trade@gmail.com">x86trade@gmail.com</a></p>
        </div>
      </div>
      <div class="footer_right">
        <p class="footer_company_about">
          <span>О компании</span>
          Наша компания имеет многолетний опыт сборки и тестирования
          конфигурация, обращайтесь!.
        </p>
        <div class="footer_icons">
          <a href="#" class="social_icon_link">
            <img
              src="images/social_network/vk.svg"
              alt="Мы ВКонтакте"
              class="social_icon_img"
            />
          </a>
          <a href="#" class="social_icon_link">
            <img
              src="images/social_network/telegram.svg"
              alt="Наш Telegram"
              class="social_icon_img"
            />
          </a>
          <a href="#" class="social_icon_link">
            <img
              src="images/social_network/facebook.svg"
              alt="Наш Email"
              class="social_icon_img"
            />
          </a>
          <a href="#" class="social_icon_link">
            <img
              src="images/social_network/instagram.svg"
              alt="Наш Instagram"
              class="social_icon_img"
            />
          </a>
        </div>
      </div>
    </footer>
  
  <script src="js/common.js"></script>
  <script src="js/api.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", async () => {
    if (!api.isAuthenticated()) {
      window.location.href = "index.html";
      return;
    }
    
    const urlParams = new URLSearchParams(window.location.search);
    const orderId = urlParams.get('order_id');
    
    if (!orderId) {
      document.getElementById('orderDetailsContainer').innerHTML = 
        '<div class="error_message">ID заказа не указан</div>';
      return;
    }
    
    try {
      // Используем правильный эндпоинт для получения деталей заказа с товарами
      const resp = await api.apiGet(`/api/orders/${orderId}`);
      
      if (!resp || !resp.order) {
        document.getElementById('orderDetailsContainer').innerHTML = 
          '<div class="error_message">Заказ не найден</div>';
        return;
      }
      
      const order = resp.order;
      const items = resp.items || [];
      const delivery = resp.delivery || null;
      
      // Формируем HTML для отображения товаров
      let html = `
        <div class="order_card">
          <div class="order_header">
            <div>
              <div class="order_number">Заказ #${order.id}</div>
              <div class="order_date">Создан: ${formatDate(order.created_at)}</div>
              ${order.updated_at ? `<div class="order_date">Обновлен: ${formatDate(order.updated_at)}</div>` : ''}
            </div>
            <div class="order_status ${order.status.toLowerCase().replace(' ', '_')}">
              ${formatOrderStatus(order.status)}
            </div>
          </div>
      `;
      
      // Если есть товары в заказе
      if (items && items.length > 0) {
        html += `
          <div class="order_items">
            <h3>Товары в заказе</h3>
            ${items.map(item => `
              <div class="order_item">
                <img src="${normalizeImageSrc(item.image_path || './images/catalog_types/cpu.svg')}" class="order_item_img" alt="${item.product_name || 'Товар'}">
                <div class="order_item_details">
                  <div class="order_item_name">${item.product_name || 'Товар #' + item.product_id}</div>
                  <div class="order_item_quantity">${item.quantity} × ${(item.price_per_unit || 0).toFixed(2)} ₽</div>
                  <div class="order_item_total">Итого: ${(item.quantity * (item.price_per_unit || 0)).toFixed(2)} ₽</div>
                </div>
              </div>
            `).join('')}
          </div>
        `;
      } else {
        html += `
          <div class="order_items">
            <h3>Товары в заказе</h3>
            <p>В этом заказе нет товаров.</p>
          </div>
        `;
      }
      
      // Продолжаем остальную часть HTML (итоги, доставка и т.д.)
      html += `
        <div class="order_total_section">
          <div class="order_total_row">
            <span>Сумма товаров:</span>
            <span>${(order.total_amount || 0).toFixed(2)} ₽</span>
          </div>
      `;
      
      if (delivery && delivery.base_cost) {
        html += `
          <div class="order_total_row">
            <span>Доставка (${delivery.method_name || 'Не указан'}):</span>
            <span>${delivery.base_cost.toFixed(2)} ₽</span>
          </div>
        `;
      }
      
      html += `
          <div class="order_total_row order_total_sum">
            <span><strong>Итого:</strong></span>
            <span><strong>${((order.total_amount || 0) + (delivery?.base_cost || 0)).toFixed(2)} ₽</strong></span>
          </div>
        </div>
      `;
      
      // Информация о доставке
      if (delivery) {
        html += `
          <div class="order_delivery">
            <h3>Информация о доставке</h3>
            <div class="order_delivery_details">
              <div><strong>Способ доставки:</strong> ${delivery.method_name || 'Не указан'}</div>
              <div><strong>Статус доставки:</strong> ${formatDeliveryStatus(delivery.status || 'pending')}</div>
              <div><strong>Адрес:</strong> ${delivery.address || 'Не указан'}</div>
              <div><strong>Получатель:</strong> ${delivery.recipient_name || 'Не указан'}</div>
              <div><strong>Контактный телефон:</strong> ${delivery.recipient_phone || 'Не указан'}</div>
            </div>
          </div>
        `;
      }
      
      // Комментарий к заказу
      if (order.comment) {
        html += `
          <div class="order_comment">
            <h3>Комментарий к заказу</h3>
            <p>${escapeHtml(order.comment)}</p>
          </div>
        `;
      }
      
      html += `</div>`;
      document.getElementById('orderDetailsContainer').innerHTML = html;
      
    } catch (err) {
      console.error('Ошибка загрузки деталей заказа:', err);
      document.getElementById('orderDetailsContainer').innerHTML = 
        `<div class="error_message">Ошибка при загрузке деталей заказа: ${err.message || err}</div>`;
    }
  });

  // Вспомогательные функции
  function normalizeImageSrc(imagePath) {
  // Путь по умолчанию для изображений
  const defaultImg = './images/catalog_types/cpu.svg';
  
  if (!imagePath) return defaultImg;
  
  const ip = String(imagePath).trim().replace(/\\/g, '/');
  const baseOrigin = window.location.origin;
  
  // Проверяем, если это уже полный URL
  if (/^https?:\/\//i.test(ip)) {
    return ip;
  }
  
  // Если путь начинается со слеша - абсолютный путь на фронтенде
  if (ip.startsWith('/')) {
    return baseOrigin + ip;
  }
  
  // Если путь начинается с images/ - относительный путь
  if (/^images\//i.test(ip)) {
    return baseOrigin + '/' + ip;
  }
  
  // Если это файловая система (Windows или file://)
  if (/^[a-zA-Z]:[\\/]/.test(ip) || /^file:\/\//i.test(ip) || ip.includes('\\')) {
    const base = ip.replace(/^.*[\\/]/, '');
    return `${baseOrigin}/images/products/${encodeURIComponent(base)}`;
  }
  
  // По умолчанию считаем, что это имя файла в папке images/products
  const base = ip.replace(/^.*[\\/]/, '');
  return `${baseOrigin}/images/products/${encodeURIComponent(base)}`;
}


  function formatDate(dateString) {
    if (!dateString) return '';
    try {
      const date = new Date(dateString);
      return date.toLocaleString('ru-RU', {
        day: '2-digit',
        month: '2-digit',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    } catch (e) {
      return dateString;
    }
  }

  function formatOrderStatus(status) {
    const statuses = {
      'created': 'Создан',
      'processing': 'В обработке',
      'shipped': 'Отправлен',
      'delivered': 'Доставлен',
      'cancelled': 'Отменен'
    };
    return statuses[status.toLowerCase()] || status;
  }

  function formatDeliveryStatus(status) {
    const statuses = {
      'pending': 'Ожидает обработки',
      'processing': 'Готовится к отправке',
      'shipped': 'Отправлен',
      'delivered': 'Доставлен',
      'cancelled': 'Отменена'
    };
    return statuses[status.toLowerCase()] || status;
  }

  function getImagePath(imagePath) {
    if (!imagePath) return './images/catalog_types/cpu.svg';
    if (imagePath.startsWith('http')) return imagePath;
    return `http://localhost:8080${imagePath.startsWith('/') ? '' : '/'}${imagePath}`;
  }

  function escapeHtml(s) {
    if (!s) return '';
    return String(s)
      .replace(/&/g, "&amp;")
      .replace(/</g, "&lt;")
      .replace(/>/g, "&gt;")
      .replace(/"/g, "&quot;")
      .replace(/'/g, "&#39;");
  }
</script>
</body>
</html>